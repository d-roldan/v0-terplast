version: '3.8'

services:
  # üß± NODE-RED VISUALIZACION
  nodered_visualizacion:
    image: nodered/node-red:latest
    container_name: nodered_visualizacion
    restart: always
    ports:
      - "1881:1880"
    environment:
      - TZ=America/Argentina/Buenos_Aires
      - NODE_RED_CREDENTIAL_SECRET=visualizacion123
    volumes:
      - ./VISUALIZACION/data:/data
    networks:
      red_sintetico:
        ipv4_address: 172.29.0.11

  # üß± NODE-RED FABRICACION
  nodered_fabricacion:
    image: nodered/node-red:latest
    container_name: nodered_fabricacion
    restart: always
    ports:
      - "1882:1880"
    environment:
      - TZ=America/Argentina/Buenos_Aires
      - NODE_RED_CREDENTIAL_SECRET=fabricacion123
    volumes:
      - ./FABRICACION/data:/data
    networks:
      red_sintetico:
        ipv4_address: 172.29.0.12

  # üß± NODE-RED LABORATORIO
  nodered_laboratorio:
    image: nodered/node-red:latest
    container_name: nodered_laboratorio
    restart: always
    ports:
      - "1883:1880"
    environment:
      - TZ=America/Argentina/Buenos_Aires
      - NODE_RED_CREDENTIAL_SECRET=laboratorio123
    volumes:
      - ./LABORATORIO/data:/data
    networks:
      red_sintetico:
        ipv4_address: 172.29.0.13
  
  node-red-envasado:
    image: nodered/node-red:latest
    container_name: node-red-envasado
    ports:
      - "1884:1880"
    volumes:
      - node-red-envasado-data:/data
    restart: unless-stopped
    networks:
      - monitoring_net

  # üõ∞Ô∏è BROKER MQTT SEGURO
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mqtt_broker
    restart: always
    ports:
      - "1884:1883"       # Puerto MQTT
      - "9001:9001"       # WebSocket opcional
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - ./mosquitto/passwords:/mosquitto/passwords
    networks:
      red_sintetico:
        ipv4_address: 172.29.0.14

  # üé® TERPLAST FRONTEND - Sistema de Control de Tanques
  terplast-frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: terplast_frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      - TZ=America/Argentina/Buenos_Aires
      - NODE_ENV=production
      - NEXT_PUBLIC_MQTT_BROKER_URL=ws://172.29.0.14:9001
      - NEXT_PUBLIC_MQTT_USERNAME=
      - NEXT_PUBLIC_MQTT_PASSWORD=
    depends_on:
      - mosquitto
    networks:
      red_sintetico:
        ipv4_address: 172.29.0.15

networks:
  red_sintetico:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
  monitoring_net:
    driver: bridge

volumes:
  node-red-envasado-data:
